export default {
  async fetch(request, env) {
    const url = new URL(request.url);
    
    if (request.method === 'GET') {
      return serveForm();
    }

    if (request.method === 'POST') {
      return handleFormSubmission(request, env);
    }

    return new Response('Not Found', { status: 404 });
  },
};

async function serveForm() {
  const html = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>Générateur de Site</title>
      <script src="https://cdn.tailwindcss.com"></script>
      <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
      <style>
      .gradient-bg {
        background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
        background-size: 400% 400%;
        animation: gradient 15s ease infinite;
      }
      </style
    </head>
    <body class="gradient-bg min-h-screen flex items-center justify-center" x-data="{ loading: false }">
      <div class="w-full max-w-2xl bg-white rounded-xl shadow-2xl p-8 mx-4">
        <h1 class="text-3xl font-bold text-center text-gray-900 mb-8">Générateur de Site</h1>
        
        <form @submit.prevent="loading = true; 
          fetch('/', { 
            method: 'POST',
            body: new FormData($event.target)
          })
          .then(r => r.text())
          .then(html => {
            const newWindow = window.open('', '_blank');
            newWindow.document.write(html);
            newWindow.document.close();
            loading = false;
          })
          .catch(e => { 
            console.error(e); 
            loading = false 
          })">
          
          <div class="space-y-6">
            <!-- Section Informations de base -->
            <div class="bg-gray-50 p-4 rounded-lg">
              <h3 class="text-lg font-semibold mb-4">Informations de base</h3>
              
              <div class="space-y-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Nom entreprise</label>
                  <input type="text" name="company" required
                    class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 text-lg">
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Slogan/Description courte</label>
                  <input type="text" name="slogan" 
                    class="w-full px-4 py-3 border rounded-lg text-lg"
                    placeholder="Ex: Votre partenaire digital premium">
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Secteur</label>
                  <select name="sector" required class="w-full px-4 py-3 border rounded-lg text-lg">
                    <option value="restauration">Restauration</option>
                    <option value="business">Business</option>
                    <option value="mode">Mode</option>
                    <option value="tourisme">Tourisme</option>
                    <option value="education">Éducation</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Section Design -->
            <div class="bg-gray-50 p-4 rounded-lg">
              <h3 class="text-lg font-semibold mb-4">Préférences de design</h3>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Couleur principale</label>
                  <input type="color" name="color" value="#3b82f6"
                    class="w-full h-14 rounded-lg cursor-pointer border">
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Couleur secondaire</label>
                  <input type="color" name="secondary_color" value="#f59e0b"
                    class="w-full h-14 rounded-lg cursor-pointer border">
                </div>
              </div>

              <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Style de design</label>
                <select name="design_style" class="w-full px-4 py-3 border rounded-lg text-lg">
                  <option value="moderne">Moderne</option>
                  <option value="classique">Classique</option>
                  <option value="minimaliste">Minimaliste</option>
                  <option value="artistique">Artistique</option>
                </select>
              </div>
            </div>

            <!-- Section Contenu -->
            <div class="bg-gray-50 p-4 rounded-lg">
              <h3 class="text-lg font-semibold mb-4">Contenu du site</h3>
              
              <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Description détaillée</label>
                <textarea name="description" rows="3"
                  class="w-full px-4 py-3 border rounded-lg text-lg"
                  placeholder="Décrivez votre entreprise en quelques lignes..."></textarea>
              </div>

              <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Contenu à inclure (case à cocher)</label>
                <div class="grid grid-cols-2 gap-2">
                  <label class="flex items-center space-x-2">
                    <input type="checkbox" name="content[]" value="gallery" class="h-4 w-4">
                    <span>Galerie photos</span>
                  </label>
                  <label class="flex items-center space-x-2">
                    <input type="checkbox" name="content[]" value="testimonials" class="h-4 w-4">
                    <span>Témoignages</span>
                  </label>
                  <label class="flex items-center space-x-2">
                    <input type="checkbox" name="content[]" value="team" class="h-4 w-4">
                    <span>Équipe</span>
                  </label>
                  <label class="flex items-center space-x-2">
                    <input type="checkbox" name="content[]" value="blog" class="h-4 w-4">
                    <span>Blog</span>
                  </label>
                </div>
              </div>
            </div>

            <!-- Section Contact -->
            <div class="bg-gray-50 p-4 rounded-lg">
              <h3 class="text-lg font-semibold mb-4">Coordonnées</h3>
              
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Email de contact</label>
                  <input type="email" name="email" required
                    class="w-full px-4 py-3 border rounded-lg text-lg">
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Téléphone</label>
                  <input type="tel" name="phone" 
                    class="w-full px-4 py-3 border rounded-lg text-lg"
                    placeholder="+33 6 12 34 56 78">
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Adresse</label>
                  <input type="text" name="address" 
                    class="w-full px-4 py-3 border rounded-lg text-lg"
                    placeholder="123 Rue Example, Paris">
                </div>
              </div>
            </div>

            <button type="submit" 
              class="w-full bg-blue-600 text-white py-4 px-8 rounded-lg hover:bg-blue-700
                     transition-all flex items-center justify-center gap-2 text-lg"
              :disabled="loading">
              <span x-show="!loading">Générer le site</span>
              <svg x-show="loading" class="animate-spin h-6 w-6 text-white" 
                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </button>
          </div>
        </form>
      </div>
    </body>
    </html>
  `;

  return new Response(html, {
    headers: { 
      'Content-Type': 'text/html',
      'Cache-Control': 'no-store, max-age=0'
    }
  });
}

async function handleFormSubmission(request, env) {
  try {
    const formData = await request.formData();

    const content = formData.getAll('content[]') || [];

    const { 
      company, 
      sector, 
      color,
      secondary_color,
      design_style,
      slogan,
      description,
      email,
      phone,
      address 
    } = Object.fromEntries(formData);

    const prompt = `[INSTRUCTIONS STRICTES - GÉNÉRATEUR DE SITE WEB PROFESSIONNEL]

    En tant qu'expert en développement web, Génère une page d'accueil HTML5 moderne et performante en respectant ces critères :
    
    1. STRUCTURE TECHNIQUE
      - DOCTYPE HTML5 obligatoire
      - Métadonnées complètes :
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="${slogan} - ${description}">
      - Intégration Bootstrap 5.3+ + AOS + Font Awesome
      - CSS personnalisé avec variables basées sur ${color} et ${secondary_color} :
        <style>
          :root {
            --primary: ${color};
            --secondary: ${secondary_color};
            --design-style: ${design_style};
          }
        </style>
      - Scripts groupés en fin de body (Bootstrap, AOS, custom)

      2. COMPOSANTS REQUIS
      Header (sticky) :
      - Logo "${company}" avec slogan "${slogan}"
      - Navigation responsive adaptée
      - CTA principal utilisant var(--secondary)
      - Style de menu cohérent avec ${design_style}

      Corps :
      [Section Hero]
      - Full viewport avec fond dégradé (primary/secondary)
      - Animation AOS fade-up
      - Texte d'accroche : ${description}

      [Sections Dynamiques]
      - Section A propos ( Texte uniqement : Titre + Description )
      - Section spécialisée ${sector} (3 colonnes avec icônes)
      - ${content.includes('gallery') ? 'Galerie modale avec filtres' : ''}
      - ${content.includes('team') ? 'Cartes équipe avec hover effects' : ''}
      - ${content.includes('testimonials') ? 'Carrousel témoignages' : ''}
      - ${content.includes('blog') ? 'Liste articles avec pagination' : ''}

      Footer (4 colonnes) :
      1. Navigation rapide
      2. Coordonnées :
        - ${address}
        - Tel: ${phone}
        - Mail: ${email}
      3. Réseaux sociaux (icônes FA)
      4. Mentions légales

      3. DESIGN & UX
      - Palette générée à partir de var(--primary) et var(--secondary)
      - Style ${design_style} :
        ${design_style === 'moderne' ? '- Bordures arrondies, ombres portées' : ''}
        ${design_style === 'classique' ? '- Encadrés, séparateurs ornementés' : ''}
        ${design_style === 'minimaliste' ? '- Espacement généreux, réduction éléments' : ''}
      - Typographie hiérarchisée (${design_style}):
        - Modern: Roboto
        - Classique: Playfair Display
        - Minimaliste: Inter
      - Animations AOS personnalisées (durée selon design_style)
      - Hover effects cohérents avec la palette
      - Images contextuelles via Picsum (thème: ${sector})

      4. CONTENU & INTERACTIONS
      - Génération de texte IA adaptée à :
        - Secteur: ${sector}
        - Style: ${design_style}
        - Longueur description: ${description.length}
      - CTAs stratégiques positionnés toutes les 2 sections
      - 10+ interactions dont :
        - Menu responsive
        - Filtres contenu
        - Modal contact
        - Tooltips infos
        - Carrousels
        - Smooth scroll
        - Validation formulaire
        ${content.includes('gallery') ? '- Lightbox galerie' : ''}
    
    5. INTERDICTIONS
    - PAS DE COMMENTAIRE 
    - PAS DE TEXTES FACTICES (LOREM IPSUM)
    - PAS DE COMPOSANTS NON STYLÉS
    - PAS DE RUPTURE DE HIÉRARCHIE VISUELLE
    - PAS DE CODE HORS BALISES HTML
    - PAS DE TEXTE EXPLICATIF DU PROMPT
    - PAS DE BALISES <think>
    
    FORMAT DE SORTIE:
    - COMMENCER DIRECTEMENT PAR <!DOCTYPE html>
    - STRUCTURE REQUISE :
    <!DOCTYPE html>
        <html lang="fr">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <title>${company} - ${sector}</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
            <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
            <style>
                :root {
                    --primary-color: ${color};
                    --secondary-color: ${secondary_color};
                    --accent-color: hsl(${Math.random() * 360}, 65%, 45%);
                }
                
                .dynamic-gradient {
                    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
                }

                .hover-zoom {
                    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                }
                .hover-zoom:hover {
                    transform: scale(1.03);
                }

                .parallax-section {
                    background-attachment: fixed;
                    background-position: center;
                    background-repeat: no-repeat;
                    background-size: cover;
                }

                .floating-icon {
                    animation: float 3s ease-in-out infinite;
                }

                @keyframes float {
                    0%, 100% { transform: translateY(0); }
                    50% { transform: translateY(-20px); }
                }

                .dynamic-shadow {
                    box-shadow: 0 10px 30px rgba(0,0,0,${Math.random() * 0.2 + 0.1});
                }
            </style>
        </head>
        <body style="scroll-behavior: smooth">
            <nav class="navbar navbar-expand-lg navbar-${Math.random() < 0.5 ? 'light' : 'dark'} ${Math.random() < 0.5 ? 'bg-transparent' : 'dynamic-gradient'} fixed-top">
                <div class="container">
                    <a class="navbar-brand" href="#" style="color: white">
                        ${company}
                    </a>
                    <ul class="navbar-nav ms-auto">
                        ${['Accueil', 'À propos', 'Services', 'Galerie', 'Contact'].map((link, i) => `
                        <li class="nav-item mx-2">
                            <a class="nav-link ${i === 0 ? 'active' : ''}" href="#${link.toLowerCase()}" 
                              data-bs-toggle="${Math.random() < 0.3 ? 'tooltip' : ''}" 
                              title="${['En savoir plus', 'Découvrir', 'Explorer'][i % 3]}">
                                ${link}
                            </a>
                        </li>
                        `).join('')}
                    </ul>
                </div>
            </nav>

            <main>
                <!-- Section Hero -->
                <section class="min-vh-100 d-flex align-items-center ${Math.random() < 0.5 ? 'parallax-section' : 'dynamic-gradient'}" 
                        style="${Math.random() < 0.5 ? `background-image: url(https://picsum.photos/seed/${sector}-hero/1920/1080)` : ''}">
                    <div class="container text-center text-${Math.random() < 0.5 ? 'light' : 'dark'}">
                        <h1 class="display-1 fw-bold mb-4">${company}</h1>
                        <div class="d-flex gap-3 justify-content-center">
                            <button class="btn btn-lg ${Math.random() < 0.5 ? 'btn-primary' : 'btn-outline-light'}">En savoir plus</button>
                            <button class="btn btn-lg ${Math.random() < 0.5 ? 'btn-secondary' : 'btn-outline-dark'}">Contact</button>
                        </div>
                    </div>
                </section>

                <!-- Section A propos -->
                <section class="py-5 ${['bg-light', 'bg-white', 'parallax-section'][Math.floor(Math.random() * 3)]}" 
                         id="about" 
                         data-aos="${['fade-up', 'zoom-in', 'flip-left'][Math.floor(Math.random() * 3)]}">
                    <div class="container">
                        <div class="${Math.random() < 0.5 ? 'align-items-center' : ''}">
                            <div class="${['p-5', 'shadow-lg', 'rounded-3'][Math.floor(Math.random() * 3)]}">
                                <div class="hover-reveal bg-dark text-white p-3">
                                    <h2>${['Notre équipe', 'Histoire', 'Engagements'][Math.floor(Math.random() * 3)]}</h2>
                                    <p>Bienvenue sur <strong>[Nom du Site]</strong>, votre référence en <strong>[domaine d’expertise]</strong>.  
                                      Notre mission est de vous fournir <strong>[produits/services proposés]</strong> pour <strong>[objectif principal du site]</strong>.</p>
                                    ${Math.random() < 0.5 ? `
                                    <div class="timeline">
                                        ${[2010, 2015, 2020].map(year => `
                                        <div class="timeline-item">
                                            <h4>${year}</h4>
                                            <p>${['Création', 'Expansion', 'Innovation'][(year-2010)/5]}</p>
                                        </div>`).join('')}
                                    </div>` : `
                                    <p class="lead">${sector === 'restauration' ? 'Depuis 2010, nous réinventons les saveurs' : 
                                                   sector === 'technologie' ? 'Pionniers en solutions digitales depuis 2015' :
                                                   'Experts reconnus dans notre domaine'}</p>`}
                                    
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Section Service/Produit/Solution -->
                <section class="py-5">
                    <div class="container">
                        <div class="row row-cols-1 row-cols-md-${Math.floor(Math.random() * 3 + 2)} g-4">
                            ${[1,2,3,4].map(i => `
                            <div class="col">
                                <div class="card h-100 hover-zoom dynamic-shadow">
                                    <img src="https://picsum.photos/seed/${sector}-card-${i}/800/600" 
                                        class="card-img-top ${Math.random() < 0.5 ? 'img-fluid' : 'rounded-circle'}">
                                    <div class="card-body">
                                        <h3 class="card-title">${['Service', 'Produit', 'Solution'][i % 3]} ${i}</h3>
                                        <p class="card-text">Découvrez notre offre exclusive</p>
                                        <button class="btn ${Math.random() < 0.5 ? 'btn-primary' : 'btn-link'}">
                                            Voir détails
                                        </button>
                                    </div>
                                </div>
                            </div>
                            `).join('')}
                        </div>
                    </div>
                </section>
            </main>

            <footer class="bg-dark text-light py-5">
                <div class="container">
                    <div class="row ${Math.random() < 0.5 ? 'row-cols-4' : 'row-cols-2 row-cols-lg-4'} g-4">
                        <div class="col">
                            <h5>Navigation</h5>
                            <ul class="list-unstyled">
                                ${['Accueil', 'Services', 'Contact', 'Mentions'].map(link => `
                                <li><a href="#" class="text-decoration-none text-secondary">${link}</a></li>
                                `).join('')}
                            </ul>
                        </div>
                        <div class="col">
                            <h5>Réseaux</h5>
                            <div class="d-flex gap-3">
                                ${['instagram', 'whatsapp', 'tiktok'].map(social => `
                                <a href="#" class="text-white floating-icon">
                                    <i class="bi bi-${social} fs-4"></i>
                                </a>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            </footer>

            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
            <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
            <script>
                AOS.init({ duration: ${Math.random() * 1000 + 500}, once: true });
                document.querySelectorAll('.hover-zoom').forEach(el => {
                    el.addEventListener('mouseover', () => el.style.transform = 'scale(1.05)');
                    el.addEventListener('mouseout', () => el.style.transform = 'scale(1)');
                });
            </script>
        </body>
        </html>`;


    const groqResponse = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${env.GROQ_API_KEY}`
      },
      body: JSON.stringify({
        model: "deepseek-r1-distill-llama-70b",
        messages: [{
          role: "system",
          content: "Vous êtes un expert en développement web fullstack spécialisé dans la génération de sites optimisés. Analysez méticuleusement chaque paramètre avant de répondre et retourner uneiquement le code generé."
        }, {
          role: "user", 
          content: prompt
        }],
        temperature: 0.4, // Meilleur équilibre entre créativité et précision
        top_p: 0.85, // Focus sur les tokens les plus pertinents
        max_tokens: 12000, // Plus réaliste pour les limites de contexte
        frequency_penalty: 0.5, // Réduit la répétition des termes
        presence_penalty: 0.3, // Encourage la diversité lexicale
        reasoning_format: "hidden", // Force un raisonnement structuré
      })

      /**
        body: JSON.stringify({
          model: "deepseek-r1-distill-llama-70b", // ou "mixtral-8x7b-32768"
          messages: [{ 
            role: "user", 
            content: prompt 
          }],
          temperature: 0.2,
          max_tokens: 50000,
          top_p: 0.9,
          stream: true,
          reasoning_format: "hidden"
        })
       */
    });

    if (!groqResponse.ok) {
      const errorData = await groqResponse.text();
      throw new Error(`Erreur Groq: ${errorData}`);
    }

    const responseData = await groqResponse.json();
    const generatedHtml = responseData.choices[0].message.content
      .replace(/```html/g, '')
      .replace(/```/g, '')
      .trim();

    return new Response(generatedHtml, {
      headers: { 
        'Content-Type': 'text/html; charset=utf-8',
        'Cache-Control': 'no-store'
      }
    });

  } catch(error) {
    console.error('Global error:', error);
    return new Response(`Erreur: ${error.message}`, { 
      status: 500,
      headers: { 'Content-Type': 'text/plain' }
    });
  }
}
